{% load static %}
{% include 'includes/control/htmx_control.html' %}
<form action="/account/payment_invoice_add_in_detail/p_{{paymentId}}" method="post" class="modal-content form-container border" id="form-{{elementTag}}-{{elementTagId}}-add-2" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="modal-body">
      <div class="row mb-1 tableBox-inform-{{elementTagSub}}-{{elementTagId}}">
        <table id="table-{{elementTagSub}}-{{elementTagId}}" class="table table-striped table-hover table-bordered dataTable no-footer" style="width:100%">
          <thead>
              <tr>
                  <th></th>
                  <th></th>
                  <th>ID</th>
                  <th>Project No</th>
                  <th>Invoice No</th>
                  <th>Invoice Date</th>
                  <th>Invoice Due Date</th>
                  <th>Invoice Total</th>
                  <th>Paid Price</th>
                  <th>Balance</th>
                  <th>Currency</th>
              </tr>
          </thead>
          <tbody id="tbody">
                  
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer shadow-5-strong" style="padding: 10px;">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" type="submit">Add</button>
    </div>
</form>

<script>
  var detailRefererPathSub = "{{refererPath}}";

  var elementTag = "{{elementTag}}";
  var elementTagSub = "{{elementTagSub}}";
  var elementTagId = "{{elementTagId}}";
  var paymentInvoiceId = "{{paymentInvoice.id}}";
  var paymentId = "{{payment.id}}";
  var paymentCustomerId = "{{payment.customer.id}}";
  var paymentType = "{{payment.type}}";
  var pageUrl = `/account/payment_invoice_add_in_detail/p_${elementTagId}/`;
  var addSubDataHxGet = `/account/payment_invoice_add_in_detail/p_${elementTagId}/`;

  $("#form-{{elementTag}}-{{elementTagId}}-add-2").submit(function (event) {
    //spinner başlatır
    $("body").busyLoad("show", {
      animation: false,
      spinner: "pulsar",
      maxSize: "150px",
      minSize: "150px",
      text: "Loading ...",
      background: "rgba(69, 83, 89, 0.6)",
      color: "#455359",
      textColor: "#fff"
    });

    event.preventDefault();

    var formData = $(this).serializeArray();

    tablePaymentInvoices = $("#table-{{elementTagSub}}-{{elementTagId}}");
    
    for(let i = 0; i < tablePaymentInvoices.DataTable().rows({selected:true}).data().length; i++){
      formData.push({name: "paymentInvoices", value: tablePaymentInvoices.DataTable().rows({selected:true}).data()[i]["id"]});
    };

    //console.log(tablePaymentInvoices.DataTable().rows({selected:true}).data());
    
    $.ajax({
      type: "POST",
      url: "/account/payment_invoice_add_in_detail/p_{{elementTagId}}/",  // Formunuzun işleneceği view'ın URL'si
      data: formData,
      success: function (response, status, xhr) {
          // Başarılı yanıt geldiğinde mesajı görüntüleyin
          if (xhr.status === 204) {
              setTimeout(function() {

                  addUpdateDataModalXl.hide();

                  $("#table-paymentPart-{{elementTagId}}").DataTable().ajax.reload(function(){
                      htmx.process("#table-paymentPart-{{elementTagId}}");
                  },false);

                  setTimeout(function() {
                      //spinner durdurur
                      $("body").busyLoad("hide", {
                      animation: "fade"
                      });
                  }, 500);
          
              }, 500);
          }
      },
      error: function (xhr, status, error) {
        //spinner durdurur
        $("body").busyLoad("hide", {
          animation: "fade"
        });
      }
    });

  });
    
</script>

{% block javascript %}

<script src="{% static 'js/account/payment_invoice/add.js' %}"></script>

{% endblock javascript %}