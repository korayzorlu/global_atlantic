{% load static %}
{% include 'includes/control/htmx_control.html' %}
<form hx-post="{{request.path}}" class="modal-content form-container border" id="form-{{elementTag}}-{{elementTagId}}-add-2" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="modal-body">
      <div class="row mb-1 tableBox-inform-{{elementTagSub}}-{{elementTagId}}">
        <table id="table-{{elementTagSub}}-{{elementTagId}}" class="table table-striped table-hover table-bordered dataTable no-footer" style="width:100%">
          <thead>
              <tr>
                <th></th>
                <th></th>
                <th>ID</th>
                <th>Maker</th>
                <th>Type</th>
                <th>Part No</th>
                <th>Group</th>
                <th>Description</th>
                <th>Tech. Spec.</th>
                <th>Manufacturer</th>
                <th>Cross Ref</th>
                <th>Unit</th>
              </tr>
          </thead>
          <tbody id="tbody">
                  
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer shadow-5-strong" style="padding: 10px;">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" type="submit">Add</button>
    </div>
</form>

<script>
  var detailRefererPathSub = "{{refererPath}}";

  var elementTag = "{{elementTag}}";
  var elementTagSub = "{{elementTagSub}}";
  var elementTagId = "{{elementTagId}}";
  var incomingInvoicePartId = "{{incomingInvoicePart.id}}";
  var incomingInvoiceId = "{{incomingInvoicePart.incomingInvoice.id}}";
  var makerId = "{{theRequest.maker.id}}";
  var makerTypeId = "{{theRequest.makerType.id}}"
  var incomingInvoiceId = "{{incomingInvoice.id}}";
  var pageUrl = "/account/incoming_invoice_part_add_in_detail/i_" + elementTagId + "/";
  var addSubDataHxGet = "/account/incoming_invoice_part_add_in_detail/i_" + elementTagId + "/";

  $("#form-{{elementTag}}-{{elementTagId}}-add-2").submit(function (event) {
    //spinner başlatır
    $("body").busyLoad("show", {
      animation: false,
      spinner: "pulsar",
      maxSize: "150px",
      minSize: "150px",
      text: "Loading ...",
      background: "rgba(69, 83, 89, 0.6)",
      color: "#455359",
      textColor: "#fff"
    });

    event.preventDefault();

    var formData = $(this).serializeArray();

    tableInquiryItems = $("#table-{{elementTagSub}}-{{elementTagId}}");
    
    for(let i = 0; i < tableInquiryItems.DataTable().rows({selected:true}).data().length; i++){
      formData.push({name: "incomingInvoiceParts", value: tableInquiryItems.DataTable().rows({selected:true}).data()[i]["id"]});
    };

    //console.log(tableInquiryItems.DataTable().rows({selected:true}).data());
    
    $.ajax({
      type: "POST",
      url: "/account/incoming_invoice_part_add_in_detail/i_{{elementTagId}}/",  // Formunuzun işleneceği view'ın URL'si
      data: formData,
      success: function (response, status, xhr) {
          // Başarılı yanıt geldiğinde mesajı görüntüleyin
          if (xhr.status === 204) {
              setTimeout(function() {

                  addUpdateDataModalXl.hide();

                  $("#table-incomingInvoicePart-{{elementTagId}}").DataTable().ajax.reload(function(){
                      htmx.process("#tale-incomingInvoicePart-{{elementTagId}}");
                  },false);

                  setTimeout(function() {
                      //spinner durdurur
                      $("body").busyLoad("hide", {
                      animation: "fade"
                      });
                  }, 500);
          
              }, 500);
              $("#message-container-{{elementTag}}-{{elementTagId}}-add-2").html('<div id="message-container-inside-{{elementTag}}-{{elementTagId}}-add-2"><i class="fas fa-check-circle me-1"></i>Saved!</div>');
              // Mesajı belirli bir süre sonra gizle
              setTimeout(function() {
                $("#message-container-inside-{{elementTag}}-{{elementTagId}}-add-2").fadeOut("slow");
              }, 500); // 3000 milisaniye (3 saniye) sonra mesaj kaybolacak
          }
      },
      error: function (xhr, status, error) {
        //spinner durdurur
        $("body").busyLoad("hide", {
          animation: "fade"
        });
          // Hata durumunda mesajı görüntüleyin
          $("#message-container-{{elementTag}}-{{elementTagId}}-add-2").html('<div id="message-container-inside-{{elementTag}}-{{elementTagId}}-add-2"><i class="fas fa-xmark-circle me-1"></i>At least one part must be selected!</div>');
      }
    });

  });
    
</script>

{% block javascript %}

<script src="{% static 'js/account/incoming_invoice_part/add.js' %}"></script>

{% endblock javascript %}